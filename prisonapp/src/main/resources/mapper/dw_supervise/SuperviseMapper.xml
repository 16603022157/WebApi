<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.prisonapp.business.dao.dw_supervise.SuperviseDao">
    <select id="getApplyLeaveList"  resultType="com.prisonapp.business.entity.dw_supervise.GetApplyLeaveListModel">
    select leaveorder as code,statuscode as statusCode, states as status,personname as applicant,subittimestamp as applyTimestamp,starttimestamp as  startTimestamp,endtimestamp as endTimestamp,
    leavedestination as  address,  reason,recording as reasonAudioUrl FROM t_leave where personid=#{userId} and statuscode=#{statusCode}
     ORDER BY subittimestamp DESC LIMIT #{requestCount} OFFSET #{count}
    </select>
    <select id="getAllApplyLeaveList"  resultType="com.prisonapp.business.entity.dw_supervise.GetApplyLeaveListModel">
    select leaveorder as code,statuscode as statusCode, states as status,personname as applicant,subittimestamp as applyTimestamp,starttimestamp as  startTimestamp,endtimestamp as endTimestamp,
    leavedestination as  address,  reason,recording as reasonAudioUrl FROM t_leave where personid=#{userId}
     ORDER BY subittimestamp DESC LIMIT #{requestCount} OFFSET #{count}
    </select>

    <select id="getTotalApplyLeaveList" resultType="com.prisonapp.business.entity.dw_supervise.SuperviseModel">
        select * FROM t_leave where personid=#{userId} and statuscode=#{statusCode}
    </select>

    <select id="applyRecord"  resultType="com.prisonapp.business.entity.dw_supervise.ApplyRecordModel">
    select  statuscode as statusCode,states as status,auditordatetime as timestamp,accountname as  person from t_auditor where leaveorder=#{code}
     </select>

    <insert id="submitApplyLeave" parameterType="com.prisonapp.business.entity.dw_supervise.SuperviseModel">
        INSERT INTO t_leave(personid, leaveorder,starttimestamp,endtimestamp,reason,recording,provincecode,provincename,citycode,cityname,areacode,areaname,statuscode,states,subittimestamp,personname)
        VALUES              (#{userId}, #{code},#{startDate},#{endDate},#{submitApplyLeaveModel.reason},#{submitApplyLeaveModel.reasonAudioUrl},#{submitApplyLeaveModel.provinceCode},#{submitApplyLeaveModel.province},#{submitApplyLeaveModel.cityCode},#{submitApplyLeaveModel.city},#{submitApplyLeaveModel.districtCode},#{submitApplyLeaveModel.district},'1','待审核',CURRENT_Time,#{personname});

        INSERT INTO t_auditor(leaveorder,leavingmessage,statuscode,states) VALUES (#{code},#{submitApplyLeaveModel.reason},1,'待审核')

    </insert>

    <select id="getPersonname" resultType="com.prisonapp.business.entity.dw_user.UserModel">
        select * from t_user where accountname =#{userId}
    </select>

    <select id="getSuperviseTask" resultType="com.prisonapp.business.entity.dw_supervise.GetSuperviseTaskModel">
        SELECT bailoutbegindate as startDate,type,typename FROM  t_personinformation FULL JOIN   t_singin on (t_personinformation.personid = t_singin.personid) where t_personinformation.personid ='25' and createtime BETWEEN CURRENT_DATE and CURRENT_DATE+1

    </select>

    <select id="faceRecognize" resultType="com.prisonapp.business.entity.dw_supervise.TPersoninformation">
    select * from t_personinformation where personid =#{userId}
    </select>

    <insert id="insertFaceRecognize">
        insert into t_singin (personid,type,result,filepath,createtime)
         values              (#{userId},#{type},#{result},#{upLoadFaceUrl},CURRENT_TIMESTAMP)
    </insert>

    <select id="getFaceRecognize" resultType="com.prisonapp.business.entity.dw_supervise.FaceRecognizeModel">
    select id as code from t_singin where type=#{type} and personid =#{userId} order by createtime desc limit 1
    </select>

    <insert id="autoLocation" >
        insert into t_location (latitude,longitude,locationtype,address,personid,timestamp) values (#{latitude},#{longitude},#{locationType},#{address},#{userId},#{date})
    </insert>

    <insert id="uploadLocationError">
        insert into t_log(operator,action,operatingtime,logtype,errorcode) values(#{userId},#{errorMsg},#{date},'2',#{errorCode})
    </insert>

    <insert id="uploadBattery">
        insert into t_location(personid,timestamp,surpluselectricity) values(#{userId},#{date},#{percent})
    </insert>

    <insert id="batteryAlarm">
        insert into t_message (modular, workcontent,personid,modularname,messagetime,readmessage,detailtype,detailtypename,personcontent)
        values                (2,#{persionName}+current_timestamp+'手机电量低于20%，请及时与其取得联系。最后一次位置：',#{userId},'报警提醒',current_timestamp,'f',1,'低电量报警通知','电池电量不足，仅剩20%的电量！')
    </insert>

    <select id="getLocationConfig" resultType="com.prisonapp.business.entity.dw_supervise.LocationModel">
        SELECT t_prisonsetting.settingcheck as enable ,t_reportsettings.locationstime as timeSpan FROM t_prisonsetting FULL JOIN t_reportsettings ON t_prisonsetting.settingcode =t_reportsettings.type WHERE personid=#{userId} and status='t' ORDER BY type ASC
    </select>
    <select id="getBatteryConfigTimestamp" resultType="com.prisonapp.business.entity.dw_supervise.GetSuperviseConfigModel">
         SELECT settingtime as lastEditTime FROM t_prisonsetting FULL JOIN t_reportsettings ON t_prisonsetting.settingcode =t_reportsettings.type WHERE personid=#{userId} and status='t' ORDER BY settingtime DESC limit 1

    </select>
</mapper>